name: Daily Job Search Alert

on:
  # Business schedules (EST → UTC)
  schedule:
    - cron: "15 5 * * *"    # 12:15 AM EST
    - cron: "15 14 * * *"   # 9:15 AM EST
    - cron: "15 18 * * *"   # 1:15 PM EST
    - cron: "15 21 * * *"   # 4:15 PM EST

    # Safety watchdog (retry window every 20 minutes)
    - cron: "*/20 * * * *"

  workflow_dispatch:

# Prevent overlapping executions
concurrency:
  group: job-search-alert
  cancel-in-progress: false

jobs:
  job-search:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # STEP 1: Decide whether this run should actually execute
      # ---------------------------------------------------------
      - name: Check last completed workflow run
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "daily_job_search.yml", // ✅ EXACT FILE NAME
                per_page: 5
              });

              const lastCompleted = runs.data.workflow_runs.find(
                r => r.status === "completed"
              );

              // If nothing completed yet → allow execution
              if (!lastCompleted) {
                core.setOutput("run", "true");
                return;
              }

              // Retry ONLY if last completed run failed
              if (lastCompleted.conclusion !== "success") {
                core.setOutput("run", "true");
              } else {
                core.setOutput("run", "false");
              }

            } catch (err) {
              // ENTERPRISE FAIL-OPEN BEHAVIOR
              // Never block business job due to metadata/API failure
              console.log("Gate check failed — allowing execution:", err.message);
              core.setOutput("run", "true");
            }

      - name: Skip execution (last run successful)
        if: steps.gate.outputs.run == 'false'
        run: |
          echo "✅ Last run successful — skipping execution."

      # ---------------------------------------------------------
      # STEP 2: Actual job (runs ONLY when needed)
      # ---------------------------------------------------------
      - name: Checkout repo
        if: steps.gate.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.gate.outputs.run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        if: steps.gate.outputs.run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser

      - name: Install Python dependencies
        if: steps.gate.outputs.run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install python-jobspy pandas

      - name: Run job scraper
        if: steps.gate.outputs.run == 'true'
        env:
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          LINKEDIN_EMAIL: ${{ secrets.LINKEDIN_EMAIL }}
          LINKEDIN_PASSWORD: ${{ secrets.LINKEDIN_PASSWORD }}
        run: |
          python job_alert_multi.py
